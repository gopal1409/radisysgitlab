stages:
    - build 
    - test
    - deploy
    - deployment test
build website:
    stage: build 
    image: node
    script:
        - echo $CI_COMMIT_SHORT_SHA	
        - npm install
        - npm install -g gatsby-cli
        - gatsby build
        - sed -i "s/%%VERSION%%/$CI_COMMIT_SHORT_SHA/" ./public/index.html
    artifacts:
        paths:
            - ./public
test artifact:
    image: alpine
    stage: test
    script: 
        - grep -q "Gatsby" ./public/index.html
    
test website:
    image: node 
    stage: test
    script:
        - npm install 
        - npm install -g gatsby-cli
        - gatsby serve &
        - sleep 3
        - curl "http://localhost:9000" | grep -q "Gatsby"

deploy to surge:
    stage: deploy
    image: node
    script:
        - npm install --global surge
        - surge --project ./public --domain  demonic-hospital.surge.sh
test deployment:
  image: alpine
  stage: deployment test
  script:
    - apk add --no-cache curl
    - curl -s "https://demonic-hospital.surge.sh" | grep -q "Welcome to Gatsby"
    - curl -s "https://demonic-hospital.surge.sh" | grep -q "$CI_COMMIT_SHORT_SHA"
